name: Terraform Unlock

on:
  workflow_dispatch:
    inputs:
      tf_dir:
        description: 'Terraform directory'
        required: true
        default: 'terraform'

jobs:
  unlock:
    runs-on: ubuntu-latest
    env:
      AWS_REGION:         ${{ secrets.AWS_REGION }}
      TF_BACKEND_BUCKET:  ${{ secrets.TF_BACKEND_BUCKET }}
      TF_BACKEND_TABLE:   ${{ secrets.TF_BACKEND_TABLE }}
      TF_BACKEND_KEY:     ${{ secrets.TF_BACKEND_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Compute backend key
        run: |
          TF_DIR="${{ github.event.inputs.tf_dir }}"
          if [[ "${TF_BACKEND_KEY}" == *.tfstate ]]; then
            echo "BACKEND_KEY=${TF_BACKEND_KEY}" >> "$GITHUB_ENV"
          else
            echo "BACKEND_KEY=${TF_BACKEND_KEY%/}/${TF_DIR}/terraform.tfstate" >> "$GITHUB_ENV"
          fi
          echo "BACKEND_KEY=$BACKEND_KEY"

      - name: Delete lock row
        run: |
          aws dynamodb delete-item \
            --table-name "$TF_BACKEND_TABLE" \
            --key "{\"LockID\":{\"S\":\"${BACKEND_KEY}\"}}" \
            --condition-expression "attribute_exists(LockID)" || true
